# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

Topic Radar (å°ˆé¡Œé›·é”) is an AI-powered news monitoring dashboard for investigative journalists. It tracks abstract topics (e.g., "migrant workers in service industry", "hoarding tax") by scraping RSS feeds, filtering with keywords, and generating AI summaries.

**Tech Stack**: Python Flask backend, Vanilla JS frontend, APScheduler for cron jobs, Perplexity AI (summaries), Anthropic Claude (keyword generation)

## Development Commands

**Setup & Run**:
```bash
cd ~/Desktop/TopicRadar
source venv/bin/activate  # Activate virtual environment
python3 app.py            # Start server on http://localhost:5001
```

**Install Dependencies**:
```bash
pip install -r requirements.txt
```

**Environment Variables** (`.env`):
```ini
PERPLEXITY_API_KEY=pplx-...      # For generating topic summaries (get from https://www.perplexity.ai/settings/api)
PERPLEXITY_MODEL=sonar           # Model to use (default: sonar)
ANTHROPIC_API_KEY=sk-ant-...     # For auto-generating keywords
```
See `.env.example` for template.

## Architecture

### Core Data Flow

1. **Topic Configuration** (`topics_config.json`): Stores topic name + keywords. Each topic has a unique ID generated by `generate_topic_id()`.
2. **RSS Scraping** (`fetch_rss()`): Fetches from 8 RSS sources (UDN, LTN, ETtoday, Twreporter, Google News). Runs every 30 minutes via APScheduler.
3. **Keyword Filtering** (`keyword_match()`): Filters news where title/summary contains ANY keyword from the topic.
4. **AI Summary** (`generate_topic_summary()`): Perplexity AI generates 100-word "latest developments" summary. Runs every 4 hours.
5. **Frontend Display**: `index.html` fetches `/api/all` and renders topic cards with summaries + top 10 news.

### Key Files

- **`app.py`**: Flask backend (lines 1-410)
  - API endpoints: `/api/all`, `/api/refresh`, `/api/refresh-summary`, `/api/admin/topics`
  - RSS scraping logic: `fetch_rss()`, `update_topic_news()` (lines 207-278)
  - AI integration: `generate_keywords_with_ai()` (Claude, lines 102-142), `generate_topic_summary()` (Perplexity, lines 146-203)
  - Scheduler: `init_scheduler()` (lines 388-392)

- **`topics_config.json`**: Topic database (persisted to disk). Structure:
  ```json
  {
    "topic_id": {
      "name": "è­°é¡Œåç¨±",
      "keywords": ["é—œéµå­—1", "é—œéµå­—2"],
      "icon": "ğŸ“Œ",  // Optional, emoji icon
      "negative_keywords": []  // Optional, currently not used in filtering
    }
  }
  ```

- **`index.html`**: Frontend dashboard (user-facing view)
  - Calls `script.js` for rendering topic cards
  - Fetches `/api/all` to display topics + news + AI summaries
  - Auto-refreshes data every 5 minutes

- **`admin.html`**: Admin interface for CRUD operations on topics
  - Inline styles and JavaScript (self-contained)
  - Create topics with AI keyword generation
  - Edit keywords manually
  - Delete topics

### Data Store (In-Memory)

```python
DATA_STORE = {
    'topics': {},      # {topic_id: [news_items]}
    'summaries': {},   # {topic_id: {'text': '...', 'updated_at': '...'}}
    'last_update': None
}
```

### RSS Sources

Configured in `app.py:34-43`. Includes:
- è¯åˆå ± (UDN), è‡ªç”±æ™‚å ± (LTN), ETtoday, å ±å°è€… (Twreporter)
- Google News Taiwan
- Specific sections like Finance/Business feeds

### Frontend Architecture (script.js)

- **Main Entry**: `loadAllData()` fetches `/api/all` and renders topic cards
- **Card Generation**: `createTopicCard()` builds HTML for each topic with:
  - Topic name + icon
  - Keywords display (comma-separated, max 8 shown)
  - AI summary with timestamp badge
  - Top 10 news items with time/source
- **Auto-refresh**: Polls `/api/all` every 5 minutes
- **Time Display Logic**:
  - Same day: "HH:MM"
  - Different day: "MM/DD"
- **Global Object**: `TopicRadar.refresh()` for manual refresh button

## Important Patterns

### Adding a New Topic
1. Admin calls `POST /api/admin/topics` with `{name: "è­°é¡Œåç¨±"}`
2. Backend calls `generate_keywords_with_ai()` to auto-generate 10-15 keywords using Claude
3. Saves to `topics_config.json`
4. Immediately runs `update_topic_news()` to fetch initial news

### Keyword Generation (Claude)
- Uses `claude-3-haiku-20240307` model
- Prompt: "é‡å°ã€Œ{topic_name}ã€é€™å€‹æ–°èè­°é¡Œï¼Œåˆ—å‡º 10-15 å€‹æœ€ç²¾æº–çš„æœå°‹é—œéµå­—"
- Returns comma-separated keywords (app.py:102-142)

### Summary Generation (Perplexity)
- Uses model from `PERPLEXITY_MODEL` env var (default: "sonar")
- System prompt: "ä½ æ˜¯ä¸€ä½è³‡æ·±çš„å°ˆé¡Œè¨˜è€…ã€‚è«‹é‡å°æŒ‡å®šè­°é¡Œæä¾›ã€Œç•¶ä¸‹æœ€æ–°é€²å±•ã€çš„æ‘˜è¦ã€‚"
- Constraint: 100 words, Traditional Chinese, removes citation markers `[1][2]`
- Includes recent news titles as context (app.py:146-203)

### Scheduler Jobs
```python
scheduler.add_job(update_topic_news, 'interval', minutes=30)  # News refresh
scheduler.add_job(update_all_summaries, 'interval', hours=4)  # AI summaries
```

## API Endpoints

- `GET /api/all`: Returns all topics with news (top 10) + summaries
- `POST /api/refresh`: Manually trigger news update
- `POST /api/refresh-summary`: Manually trigger AI summary regeneration
- `GET /api/admin/topics`: Get all topics config
- `POST /api/admin/topics`: Create new topic (body: `{name: "..."}`)
- `PUT /api/admin/topics/<tid>`: Update keywords (body: `{keywords: [...]}`)
- `DELETE /api/admin/topics/<tid>`: Delete topic

## Important Notes

- **No Database**: All state is in-memory (`DATA_STORE`) and resets on restart. Only `topics_config.json` persists.
- **Deduplication**: Uses MD5 hash of title to prevent duplicate news in same topic (app.py:267-270).
- **Time Display**: Shows `HH:MM` for today's news, `MM/DD` for older news (app.py:313-316).
- **SSL Warnings Disabled**: `urllib3.disable_warnings()` is called to avoid RSS fetch warnings when scraping (app.py:395-396).
- **Port**: Server runs on port 5001 to avoid conflicts with common dev servers.
- **Scheduler**: Uses APScheduler with `use_reloader=False` to prevent duplicate jobs in debug mode (app.py:410).
- **Virtual Environment**: Project uses venv at `~/Desktop/TopicRadar/venv/`. Always activate before running.
- **Frontend Stack**: Vanilla JavaScript (no framework), single-page dashboard with auto-refresh.

## Common Development Workflows

### Testing RSS Scraping
To test RSS feed changes without waiting for scheduler:
```bash
# Start Python REPL in venv
python3
>>> from app import fetch_rss
>>> items = fetch_rss('https://udn.com/rssfeed/news/2/0', 'è¯åˆå ±')
>>> print(len(items), items[0] if items else 'No items')
```

### Manual API Testing
```bash
# Refresh news immediately
curl -X POST http://localhost:5001/api/refresh

# Regenerate AI summaries
curl -X POST http://localhost:5001/api/refresh-summary

# Get all data
curl http://localhost:5001/api/all | python3 -m json.tool
```

### Modifying AI Prompts
- **Keyword generation**: Edit prompt in `generate_keywords_with_ai()` (app.py:122)
- **Summary generation**: Edit system/user prompts in `generate_topic_summary()` (app.py:178-183)
- After changes, restart server and call `/api/refresh-summary` to regenerate

### Adding New RSS Sources
1. Add to `RSS_SOURCES` dict in app.py:34-43
2. Test with `fetch_rss()` function first
3. Restart server - scheduler will auto-include new source
