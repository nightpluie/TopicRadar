# TopicRadar 技術債務與優化建議

**評估日期**: 2026-01-22  
**當前版本**: v2.1.0

---

## 目前程式碼現況

### 規模統計
- **app.py**: ~2,876 行
- **admin.html**: ~1,401 行
- **script.js**: ~566 行
- **index.html**: ~69 行
- **總計**: 約 4,900 行程式碼

### 架構特點
- 單一 Python 檔案（app.py）包含所有後端邏輯
- Vanilla JS（無框架）
- 混合式資料儲存（記憶體 + JSON 檔案 + Supabase）

---

## 技術債務清單

### 高優先級

#### 1. app.py 過於龐大（2,876 行）
**問題**：
- 所有後端邏輯集中在單一檔案
- 難以維護和測試
- 功能耦合度高

**影響**：
- 新功能開發困難
- Bug 修復風險高
- 程式碼可讀性差

**建議方案**：
```
app/
├── __init__.py
├── main.py          # Flask app 初始化
├── routes/          # API 路由
│   ├── api.py
│   ├── admin.py
│   └── auth.py
├── services/        # 業務邏輯
│   ├── news.py      # RSS 抓取
│   ├── ai.py        # AI 整合
│   └── keywords.py  # 關鍵字處理
├── models/          # 資料模型
│   └── topic.py
└── utils/           # 工具函數
    ├── translation.py
    └── scheduler.py
```

#### 2. 混合資料儲存策略
**問題**：
- 記憶體資料（DATA_STORE）伺服器重啟後消失
- JSON 檔案（topics_config.json）與 Supabase 資料分離
- 資料一致性難以保證

**影響**：
- 部署到 Render 後新聞資料不會持久化
- 使用者體驗不佳（重啟後需重新抓取）

**建議方案**：
- 選項 A：全部遷移到 Supabase（新增 `news` 和 `summaries` 表）
- 選項 B：使用 Redis 作為快取層（需要額外服務）
- 選項 C：維持現狀，但增加定期備份機制

---

### 中優先級

#### 3. 缺乏單元測試
**問題**：
- 零測試覆蓋率
- 重構風險極高
- 難以驗證功能正確性

**建議方案**：
- 使用 pytest 建立測試框架
- 優先測試核心功能（RSS 抓取、關鍵字過濾）
- 目標：至少 50% 覆蓋率

#### 4. API Rate Limiting 不足
**問題**：
- Gemini/Perplexity API 沒有請求限制
- 可能觸發第三方 API 限制
- 缺少錯誤次數追蹤

**建議方案**：
- 實作簡單的 rate limiter
- 追蹤 API 使用量
- 優雅降級處理

#### 5. 前端狀態管理混亂
**問題**：
- 全域變數散落各處
- DOM 操作直接耦合邏輯
- 難以除錯

**建議方案**：
- 考慮輕量級框架（Alpine.js 或 Petite Vue）
- 或建立簡單的狀態管理模式

---

### 低優先級

#### 6. 缺少錯誤監控
**問題**：
- 只有 console.log
- 無法追蹤生產環境錯誤

**建議方案**：
- 整合 Sentry（免費方案）
- 或簡單的錯誤日誌系統

#### 7. 環境變數管理
**問題**：
- .env 檔案沒有驗證
- 缺少預設值處理

**建議方案**：
- 使用 pydantic-settings
- 啟動時驗證必要環境變數

---

## 效能優化建議

### 已完成優化（v2.1）
- ✅ 翻譯速度 3 倍提升
- ✅ 新增專題 15 倍提升
- ✅ 背景執行緒處理

### 可進一步優化

#### 1. RSS 抓取並行化
**目前**：逐個抓取 RSS（12 個來源）
**優化**：使用 `concurrent.futures` 並行抓取
**預期**：抓取時間從 30-60 秒降至 10-15 秒

#### 2. 前端輪詢優化
**目前**：無自動刷新
**建議**：每 5 分鐘自動輪詢 `/api/all`
**好處**：使用者不需手動刷新

#### 3. 資料庫查詢優化
**目前**：每次請求都查詢所有專題
**建議**：實作簡單的應用層快取（5 分鐘 TTL）

---

## 代碼簡化評估

### 是否需要啟動 code-simplifier 技能？

**建議**：**暫時不需要**

**理由**：
1. **程式碼品質尚可**：雖然檔案大，但邏輯清晰
2. **功能穩定**：v2.1 已完成重大優化
3. **重構風險高**：缺乏測試，大規模重構可能引入 bug

### 建議的漸進式改進策略

#### 階段 1：準備工作（v2.2）
- [ ] 建立基礎測試框架
- [ ] 核心功能單元測試（RSS、過濾）
- [ ] 整合測試（API 端點）

#### 階段 2：模組化（v2.3）
- [ ] 提取 AI 整合邏輯到 `services/ai.py`
- [ ] 提取 RSS 邏輯到 `services/news.py`
- [ ] 提取路由到 `routes/` 資料夾

#### 階段 3：資料層優化（v3.0）
- [ ] 新聞資料遷移到 Supabase
- [ ] 實作快取策略
- [ ] 移除 JSON 檔案依賴

---

## 立即可執行的小改進

### Quick Wins（不需要大規模重構）

1. **增加 RSS 並行抓取**
   - 修改 `update_all_news_domestic()` 使用 ThreadPoolExecutor
   - 預估工作量：1 小時
   - 效能提升：3-4 倍

2. **增加 API 錯誤處理**
   - 統一錯誤回應格式
   - 增加請求驗證
   - 預估工作量：2 小時

3. **前端自動刷新**
   - 添加輪詢機制
   - Toast 通知更新
   - 預估工作量：1 小時

4. **環境變數驗證**
   - 啟動時檢查必要變數
   - 提供友善錯誤訊息
   - 預估工作量：30 分鐘

---

## 總結

### 技術債務優先順序
1. 🔴 **app.py 模組化**（重要但風險高，需先建立測試）
2. 🟡 **資料持久化**（可選，目前可接受）
3. 🟢 **效能優化**（RSS 並行化，立即可做）

### 建議行動
1. **短期**：實作 Quick Wins，立即見效
2. **中期**：建立測試框架，為重構鋪路
3. **長期**：漸進式模組化，降低技術債務

### 是否使用 code-simplifier？
**建議等到 v2.3 或 v3.0**，當有完整測試覆蓋後再進行大規模重構。
