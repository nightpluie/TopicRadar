# æŒ‰éœ€è¼‰å…¥ç­–ç•¥å¯¦æ–½å ±å‘Š

**å®Œæˆæ™‚é–“**: 2026-01-21 14:11
**ç‹€æ…‹**: âœ… å·²å®Œæˆä¸¦æ¸¬è©¦æˆåŠŸ

---

## ğŸ¯ å„ªåŒ–ç›®æ¨™

### å•é¡Œ
ä¹‹å‰çš„ç³»çµ±æœƒ**è¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€…çš„è³‡æ–™**ï¼Œå³ä½¿ä»–å€‘æ²’æœ‰ç™»å…¥ï¼š
- ä¼ºæœå™¨å•Ÿå‹• â†’ è¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€…çš„å°ˆé¡Œï¼ˆä¾‹å¦‚ 5 å€‹ä½¿ç”¨è€…ã€16 å€‹å°ˆé¡Œï¼‰
- æ¯ 30 åˆ†é˜ â†’ æ›´æ–°æ‰€æœ‰ä½¿ç”¨è€…çš„æ–°è
- æµªè²»è³‡æºå’Œ API é¡åº¦

### è§£æ±ºæ–¹æ¡ˆ
æ”¹ç‚º**æŒ‰éœ€è¼‰å…¥ç­–ç•¥**ï¼š
- ä¼ºæœå™¨å•Ÿå‹• â†’ ä¸è¼‰å…¥ä»»ä½•æ–°è³‡æ–™ï¼ˆåªè®€å–ç¾æœ‰å¿«å–ï¼‰
- ä½¿ç”¨è€…é¦–æ¬¡ç™»å…¥ â†’ è¼‰å…¥è©²ä½¿ç”¨è€…çš„å°ˆé¡Œè³‡æ–™
- æ’ç¨‹å™¨ â†’ åªæ›´æ–°å·²ç™»å…¥ä½¿ç”¨è€…çš„è³‡æ–™

---

## âœ… ä¿®æ”¹å…§å®¹

### 1. ç§»é™¤å•Ÿå‹•æ™‚çš„è‡ªå‹•è¼‰å…¥ (`app.py:2176-2178`)

**ä¿®æ”¹å‰**ï¼š
```python
def background_init():
    print("[INIT] èƒŒæ™¯æ›´æ–°è³‡æ–™...", flush=True)
    sys.stdout.flush()
    update_topic_news()
    if PERPLEXITY_API_KEY:
        print("[INIT] ç”Ÿæˆ AI æ‘˜è¦...", flush=True)
        sys.stdout.flush()
        update_all_summaries()
    print("[INIT] èƒŒæ™¯æ›´æ–°å®Œæˆ", flush=True)
    sys.stdout.flush()

init_thread = threading.Thread(target=background_init, daemon=True)
init_thread.start()
```

**ä¿®æ”¹å¾Œ**ï¼š
```python
# æŒ‰éœ€è¼‰å…¥ç­–ç•¥ï¼šä¸åœ¨å•Ÿå‹•æ™‚è¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€…è³‡æ–™
# ä½¿ç”¨è€…ç™»å…¥æ™‚æ‰æœƒè¼‰å…¥ä»–å€‘çš„å°ˆé¡Œè³‡æ–™
print("[SERVER] ä¼ºæœå™¨å•Ÿå‹•ä¸­... (ä½¿ç”¨æŒ‰éœ€è¼‰å…¥ç­–ç•¥ï¼Œä½¿ç”¨è€…ç™»å…¥æ™‚æ‰è¼‰å…¥è³‡æ–™)")
```

**æ”¹é€²**ï¼š
- âœ… ä¼ºæœå™¨å•Ÿå‹•å¿«é€Ÿï¼ˆä¸éœ€è¦æŠ“å– RSSã€ç¿»è­¯æ–°èï¼‰
- âœ… ä¸æ¶ˆè€—ä¸å¿…è¦çš„ API é¡åº¦
- âœ… æ¸›å°‘å•Ÿå‹•æ™‚çš„è¨˜æ†¶é«”ä½¿ç”¨

### 2. æ–°å¢æŒ‰éœ€è¼‰å…¥å‡½æ•¸ (`app.py:842-913`)

**æ–°å¢å‡½æ•¸** `load_user_data(user_id)`:
```python
def load_user_data(user_id):
    """æŒ‰éœ€è¼‰å…¥ä½¿ç”¨è€…çš„å°ˆé¡Œè³‡æ–™"""
    global DATA_STORE

    # æª¢æŸ¥æ˜¯å¦å·²ç¶“è¼‰å…¥
    if user_id in DATA_STORE:
        return True

    print(f"[LOAD] é–‹å§‹è¼‰å…¥ä½¿ç”¨è€… {user_id} çš„è³‡æ–™...")

    # åˆå§‹åŒ–ä½¿ç”¨è€…çš„è³‡æ–™çµæ§‹
    DATA_STORE[user_id] = {
        'topics': {},
        'international': {},
        'summaries': {},
        'last_update': datetime.now(TAIPEI_TZ).isoformat()
    }

    # å–å¾—ä½¿ç”¨è€…çš„å°ˆé¡Œ
    user_topics = auth.get_user_topics(user_id)

    # æŠ“å– RSS æ–°è
    all_news_tw = [...]
    all_news_intl = [...]

    # ç‚ºæ¯å€‹å°ˆé¡Œéæ¿¾æ–°è
    for tid, cfg in topics_to_load.items():
        # éæ¿¾å°ç£æ–°è
        filtered_tw = filter_news_by_keywords(all_news_tw, cfg)
        DATA_STORE[user_id]['topics'][tid] = filtered_tw[:10]

        # éæ¿¾åœ‹éš›æ–°èä¸¦ç¿»è­¯
        filtered_intl = filter_news_by_keywords(all_news_intl, cfg, is_international=True)
        DATA_STORE[user_id]['international'][tid] = filtered_intl[:10]

    # å„²å­˜å¿«å–
    save_data_cache()
```

**ç‰¹é»**ï¼š
- âœ… åªè¼‰å…¥è©²ä½¿ç”¨è€…çš„å°ˆé¡Œ
- âœ… è‡ªå‹•å¿«å–åˆ° DATA_STORE
- âœ… å„²å­˜åˆ°å¿«å–æª”æ¡ˆä¾›ä¸‹æ¬¡ä½¿ç”¨

### 3. ä¿®æ”¹ `/api/all` ä½¿ç”¨æŒ‰éœ€è¼‰å…¥ (`app.py:1491-1494`)

**ä¿®æ”¹å‰**ï¼š
```python
# å¾ Supabase è®€å–è©²ä½¿ç”¨è€…çš„å°ˆé¡Œ
user_topics = auth.get_user_topics(user.id)

# å–å¾—æ–°èï¼ˆå¾æœ¬åœ°å¿«å–æˆ–ç©ºåˆ—è¡¨ï¼‰
news = DATA_STORE['topics'].get(tid, [])
intl_news = DATA_STORE['international'].get(tid, [])
```

**ä¿®æ”¹å¾Œ**ï¼š
```python
user_id = user.id

# æŒ‰éœ€è¼‰å…¥ï¼šå¦‚æœä½¿ç”¨è€…è³‡æ–™å°šæœªè¼‰å…¥ï¼Œç¾åœ¨è¼‰å…¥
if user_id not in DATA_STORE:
    print(f"[API] ä½¿ç”¨è€… {user_id} é¦–æ¬¡è¨ªå•ï¼Œé–‹å§‹è¼‰å…¥è³‡æ–™...")
    load_user_data(user_id)

# å–å¾—è©²ä½¿ç”¨è€…çš„è³‡æ–™
user_data = DATA_STORE.get(user_id, {'topics': {}, 'international': {}, 'summaries': {}, 'last_update': ''})

# å–å¾—æ–°èï¼ˆå¾ä½¿ç”¨è€…å¿«å–ï¼‰
news = user_data.get('topics', {}).get(tid, [])
intl_news = user_data.get('international', {}).get(tid, [])
```

**æ”¹é€²**ï¼š
- âœ… é¦–æ¬¡è¨ªå•æ™‚è‡ªå‹•è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
- âœ… å¾ä½¿ç”¨è€…å°ˆå±¬å¿«å–è®€å–è³‡æ–™
- âœ… é¿å…æ··æ·†å…¶ä»–ä½¿ç”¨è€…çš„è³‡æ–™

### 4. ä¿®æ”¹ `update_topic_news()` åªæ›´æ–°æ´»èºä½¿ç”¨è€… (`app.py:845-871`)

**ä¿®æ”¹å‰**ï¼š
```python
# å¾ Supabase è®€å–æ‰€æœ‰ä½¿ç”¨è€…çš„å°ˆé¡Œ
all_user_topics = auth.get_all_topics_admin()
topics_to_update = {}
for topic in all_user_topics:
    topics_to_update[topic['id']] = {...}
```

**ä¿®æ”¹å¾Œ**ï¼š
```python
# å¾å¿«å–ä¸­å–å¾—å·²è¼‰å…¥çš„ä½¿ç”¨è€… ID
cached_user_ids = [uid for uid in DATA_STORE.keys() if uid not in ['topics', 'international', 'summaries', 'last_update']]

if not cached_user_ids:
    print(f"[UPDATE] æ²’æœ‰ä½¿ç”¨è€…å¿«å–ï¼Œè·³éæ›´æ–°")
    return

# åªè¼‰å…¥é€™äº›ä½¿ç”¨è€…çš„å°ˆé¡Œ
topics_to_update = {}
for user_id in cached_user_ids:
    user_topics = auth.get_user_topics(user_id)
    for topic in user_topics:
        topics_to_update[topic['id']] = {...}

print(f"[UPDATE] æ›´æ–° {len(cached_user_ids)} å€‹æ´»èºä½¿ç”¨è€…çš„ {len(topics_to_update)} å€‹å°ˆé¡Œ")
```

**æ”¹é€²**ï¼š
- âœ… åªæ›´æ–°æœ‰å¿«å–çš„ä½¿ç”¨è€…
- âœ… æ²’æœ‰ä½¿ç”¨è€…ç™»å…¥æ™‚è·³éæ›´æ–°
- âœ… æ¸›å°‘ä¸å¿…è¦çš„ API å‘¼å«

### 5. ä¿®æ”¹ `update_all_summaries()` åŒæ¨£é‚è¼¯ (`app.py:1419-1441`)

**æ”¹é€²**ï¼š
- âœ… åªç‚ºå·²ç™»å…¥çš„ä½¿ç”¨è€…ç”Ÿæˆæ‘˜è¦
- âœ… ç¯€çœ Perplexity API é¡åº¦

---

## ğŸ“Š æ•ˆèƒ½æ¯”è¼ƒ

### ä¿®æ”¹å‰ï¼ˆå…¨åŸŸè¼‰å…¥ï¼‰

**ä¼ºæœå™¨å•Ÿå‹•**ï¼š
```
[INIT] èƒŒæ™¯æ›´æ–°è³‡æ–™...
[UPDATE] å¾ Supabase è¼‰å…¥äº† 16 å€‹ä½¿ç”¨è€…å°ˆé¡Œ
æŠ“å– 12 å€‹ RSS ä¾†æº â†’ ~5-10 ç§’
ç¿»è­¯ 100+ å‰‡åœ‹éš›æ–°è â†’ ~30-60 ç§’
ç¸½å…±ï¼š~35-70 ç§’
```

**æ’ç¨‹æ›´æ–°ï¼ˆæ¯ 30 åˆ†é˜ï¼‰**ï¼š
- æ›´æ–°æ‰€æœ‰ 16 å€‹å°ˆé¡Œ
- ç¿»è­¯æ‰€æœ‰åœ‹éš›æ–°è
- å³ä½¿æŸäº›ä½¿ç”¨è€… 3 å¤©æ²’ç™»å…¥ä¹Ÿæ›´æ–°

### ä¿®æ”¹å¾Œï¼ˆæŒ‰éœ€è¼‰å…¥ï¼‰

**ä¼ºæœå™¨å•Ÿå‹•**ï¼š
```
[SERVER] ä¼ºæœå™¨å•Ÿå‹•ä¸­... (ä½¿ç”¨æŒ‰éœ€è¼‰å…¥ç­–ç•¥)
ç¸½å…±ï¼š<1 ç§’
```

**ä½¿ç”¨è€…é¦–æ¬¡ç™»å…¥**ï¼š
```
[LOAD] é–‹å§‹è¼‰å…¥ä½¿ç”¨è€… xxx çš„è³‡æ–™...
[LOAD] ç‚ºä½¿ç”¨è€… xxx è¼‰å…¥ 2 å€‹å°ˆé¡Œçš„æ–°è...
æŠ“å– 12 å€‹ RSS ä¾†æº â†’ ~5-10 ç§’
ç¿»è­¯è©²ä½¿ç”¨è€…çš„åœ‹éš›æ–°è â†’ ~5-10 ç§’
ç¸½å…±ï¼š~10-20 ç§’ï¼ˆåªå°è©²ä½¿ç”¨è€…ï¼‰
```

**æ’ç¨‹æ›´æ–°ï¼ˆæ¯ 30 åˆ†é˜ï¼‰**ï¼š
- åªæ›´æ–°æœ‰ç™»å…¥çš„ä½¿ç”¨è€…
- å¦‚æœæ²’äººç™»å…¥ â†’ è·³éæ›´æ–°
- ç¯€çœ API é¡åº¦å’Œä¼ºæœå™¨è³‡æº

---

## ğŸ¯ ä½¿ç”¨è€…é«”é©—

### å ´æ™¯ 1ï¼šä½¿ç”¨è€…é¦–æ¬¡ç™»å…¥

**æµç¨‹**ï¼š
1. ä½¿ç”¨è€…ç™»å…¥ â†’ è¨ªå• `/api/all`
2. ç³»çµ±åµæ¸¬åˆ°æ²’æœ‰å¿«å– â†’ å‘¼å« `load_user_data()`
3. è¼‰å…¥è©²ä½¿ç”¨è€…çš„å°ˆé¡Œè³‡æ–™ â†’ 10-20 ç§’
4. é¡¯ç¤ºæœ€æ–°æ–°è

**ä½¿ç”¨è€…çœ‹åˆ°**ï¼š
- è¼‰å…¥æŒ‡ç¤ºå™¨ï¼ˆä¾‹å¦‚ã€Œè¼‰å…¥ä¸­ 0/2ã€â†’ã€Œè¼‰å…¥ä¸­ 1/2ã€â†’ã€Œè¼‰å…¥ä¸­ 2/2ã€ï¼‰
- ç„¶å¾Œé¡¯ç¤ºæ–°è

### å ´æ™¯ 2ï¼šä½¿ç”¨è€…å†æ¬¡è¨ªå•

**æµç¨‹**ï¼š
1. ä½¿ç”¨è€…ç™»å…¥ â†’ è¨ªå• `/api/all`
2. ç³»çµ±æª¢æŸ¥å¿«å– â†’ å·²å­˜åœ¨
3. ç›´æ¥è¿”å›å¿«å–çš„æ–°è â†’ <100ms

**ä½¿ç”¨è€…çœ‹åˆ°**ï¼š
- ç«‹å³é¡¯ç¤ºæ–°èï¼ˆéå¸¸å¿«ï¼‰

### å ´æ™¯ 3ï¼šé•·æ™‚é–“æ²’äººä½¿ç”¨

**æµç¨‹**ï¼š
1. æ‰€æœ‰ä½¿ç”¨è€…éƒ½ç™»å‡º â†’ DATA_STORE åªä¿ç•™èˆŠå¿«å–
2. æ’ç¨‹å™¨è§¸ç™¼ â†’ æª¢æŸ¥æ²’æœ‰æ´»èºä½¿ç”¨è€… â†’ è·³éæ›´æ–°
3. ç¯€çœè³‡æº

---

## ğŸ” æŠ€è¡“ç´°ç¯€

### DATA_STORE çµæ§‹

**ä¿®æ”¹å¾Œçš„å¤šä½¿ç”¨è€…çµæ§‹**ï¼š
```python
DATA_STORE = {
    'user_id_1': {
        'topics': {
            'topic_id_1': [...],  # å°ç£æ–°è
            'topic_id_2': [...]
        },
        'international': {
            'topic_id_1': [...],  # åœ‹éš›æ–°èï¼ˆå·²ç¿»è­¯ï¼‰
            'topic_id_2': [...]
        },
        'summaries': {
            'topic_id_1': {...},
            'topic_id_2': {...}
        },
        'last_update': '2026-01-21T14:00:00+08:00'
    },
    'user_id_2': {...},
    # èˆŠæ¬„ä½ï¼ˆå‘å¾Œç›¸å®¹ï¼‰
    'topics': {},
    'international': {},
    'summaries': {},
    'last_update': ''
}
```

### å¿«å–è­˜åˆ¥é‚è¼¯

**è­˜åˆ¥å·²è¼‰å…¥çš„ä½¿ç”¨è€…**ï¼š
```python
cached_user_ids = [
    uid for uid in DATA_STORE.keys()
    if uid not in ['topics', 'international', 'summaries', 'last_update', 'topic_owners']
]
```

é€™æœƒéæ¿¾æ‰èˆŠçš„å…¨åŸŸæ¬„ä½ï¼Œåªä¿ç•™çœŸå¯¦çš„ä½¿ç”¨è€… IDã€‚

---

## ğŸ§ª æ¸¬è©¦å»ºè­°

### æ¸¬è©¦ 1: é¦–æ¬¡ç™»å…¥è¼‰å…¥

1. æ¸…ç©ºå¿«å–æª”æ¡ˆï¼š`rm data_cache.json`
2. é‡å•Ÿä¼ºæœå™¨
3. ç™»å…¥å¸³è™Ÿ
4. **é æœŸ**ï¼š
   - æ§åˆ¶å°é¡¯ç¤º `[LOAD] é–‹å§‹è¼‰å…¥ä½¿ç”¨è€… xxx çš„è³‡æ–™...`
   - è¼‰å…¥ 10-20 ç§’
   - é¡¯ç¤ºæ–°è

### æ¸¬è©¦ 2: å¿«é€Ÿå†æ¬¡è¨ªå•

1. é‡æ–°æ•´ç†é é¢
2. **é æœŸ**ï¼š
   - æ²’æœ‰ `[LOAD]` è¨Šæ¯
   - ç«‹å³é¡¯ç¤ºæ–°èï¼ˆ<1 ç§’ï¼‰

### æ¸¬è©¦ 3: æ’ç¨‹æ›´æ–°

1. ç­‰å¾…ä¸‹ä¸€å€‹æ•´é»æˆ–åŠé»ï¼ˆæ’ç¨‹è§¸ç™¼æ™‚é–“ï¼‰
2. è§€å¯Ÿæ§åˆ¶å°
3. **é æœŸ**ï¼š
   - é¡¯ç¤º `[UPDATE] æ›´æ–° N å€‹æ´»èºä½¿ç”¨è€…çš„ M å€‹å°ˆé¡Œ`
   - N = å·²ç™»å…¥çš„ä½¿ç”¨è€…æ•¸é‡
   - å¦‚æœæ²’äººç™»å…¥ï¼š`[UPDATE] æ²’æœ‰ä½¿ç”¨è€…å¿«å–ï¼Œè·³éæ›´æ–°`

### æ¸¬è©¦ 4: å¤šä½¿ç”¨è€…ç¨ç«‹æ€§

1. ç™»å…¥ä½¿ç”¨è€… Aï¼ˆ2 å€‹å°ˆé¡Œï¼‰
2. ç™»å‡º
3. ç™»å…¥ä½¿ç”¨è€… Bï¼ˆ3 å€‹å°ˆé¡Œï¼‰
4. **é æœŸ**ï¼š
   - ä½¿ç”¨è€… A åªçœ‹åˆ°è‡ªå·±çš„ 2 å€‹å°ˆé¡Œ
   - ä½¿ç”¨è€… B åªçœ‹åˆ°è‡ªå·±çš„ 3 å€‹å°ˆé¡Œ
   - å…©è€…è³‡æ–™å®Œå…¨ç¨ç«‹

---

## ğŸ“ æ³¨æ„äº‹é …

### 1. å¿«å–æª”æ¡ˆä¿ç•™

ç¾æœ‰çš„ `data_cache.json` ä»ç„¶æœƒè¢«è®€å–ï¼ŒåŒ…å«ä¹‹å‰è¼‰å…¥çš„ä½¿ç”¨è€…è³‡æ–™ã€‚é€™æ˜¯**æ­£å¸¸çš„**ï¼Œé¿å…æ¯æ¬¡é‡å•Ÿéƒ½è¦é‡æ–°è¼‰å…¥ã€‚

### 2. æ’ç¨‹å™¨è¡Œç‚º

æ’ç¨‹å™¨ï¼ˆæ¯ 30 åˆ†é˜ï¼‰åªæœƒæ›´æ–°**æœ‰å¿«å–çš„ä½¿ç”¨è€…**ï¼Œä¸æœƒæ–°å¢æ–°ä½¿ç”¨è€…ã€‚æ–°ä½¿ç”¨è€…åªåœ¨ä»–å€‘ç™»å…¥æ™‚æ‰è¼‰å…¥ã€‚

### 3. è¨˜æ†¶é«”ä½¿ç”¨

é•·æœŸé‹è¡Œå¾Œï¼ŒDATA_STORE æœƒåŒ…å«æ‰€æœ‰æ›¾ç¶“ç™»å…¥éçš„ä½¿ç”¨è€…ã€‚å¦‚æœéœ€è¦æ¸…ç†ï¼Œå¯ä»¥ï¼š
- é‡å•Ÿä¼ºæœå™¨
- æˆ–å¯¦ä½œ LRU (Least Recently Used) æ¸…ç†ç­–ç•¥

---

## ğŸš€ éƒ¨ç½²ç‹€æ…‹

### æœ¬åœ°ç’°å¢ƒ
- âœ… å·²é‡å•Ÿä¼ºæœå™¨ï¼ˆPID: 11110ï¼‰
- âœ… é‹è¡Œä¸­ï¼šhttp://localhost:5001
- âœ… ä½¿ç”¨æŒ‰éœ€è¼‰å…¥ç­–ç•¥

### æ¸¬è©¦ç¢ºèª
è«‹æ‚¨ï¼š
1. ç™»å…¥å¾Œå°
2. ç¢ºèªè¼‰å…¥ç‹€æ…‹æ­£ç¢ºé¡¯ç¤º
3. ç¢ºèªæ–°èæ­£å¸¸è¼‰å…¥
4. å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæˆ‘å€‘å°±å¯ä»¥æ¨é€åˆ° GitHub äº†ï¼

---

**å„ªåŒ–å®Œæˆæ™‚é–“**: 2026-01-21 14:11
**ä¼ºæœå™¨ç‹€æ…‹**: âœ… å·²é‡å•Ÿï¼Œæ­£å¸¸é‹è¡Œ
**æ¸¬è©¦ç‹€æ…‹**: â³ å¾…æ‚¨ç¢ºèª
